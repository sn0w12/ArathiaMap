<!DOCTYPE html>
<html = style="height: 100%;">

<head>
	<title>Arathia World Map</title>
	<link rel="icon" href="icons/arathia.png">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="scripts/leaflet.css">
	<link rel="stylesheet" href="scripts/src/leaflet.groupedlayercontrol.css" />
	<link rel="stylesheet" href="scripts/leaflet-search/src/leaflet-search.css" />
	<link rel="stylesheet" href="style.css">
	<script src="scripts/leaflet.js"></script>
</head>

<body style="height: 100%;margin: 0;overflow-y: hidden;overflow-x: hidden;">
	<div id="map" style="width: 100%; height: 100%; background: #31565a;"></div>
	<a class="leaflet-control-zoom-out" href="index" title="Zoom out" role="button"
        aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">−</span></a>
	<script src="scripts/src/leaflet.groupedlayercontrol.js"></script>
	<script src="scripts/leaflet-search/src/leaflet-search.js"></script>
	<script type="text/javascript">
		function generatePopupContent(title, category, description, linkEnabled, linkTitle) {
			// If linkEnabled is true and linkTitle is provided, it uses linkTitle for the hyperlink otherwise it uses the title for the hyperlink.
			// If linkEnabled is false, it just displays the title without a hyperlink.
			const titleLink = linkEnabled 
				? `<a href="wiki#${encodeURIComponent(linkTitle || title)}" target="_blank"><b><font size="+0.5">${title}</font></b><br /></a>`
				: `<b><font size="+0.5">${title}</font></b><br />`;

			// Image styles
			const img1 = '<img style="height:17.5px;width: 100%;min-width: 175px; display: block; margin-left: auto; margin-right: auto; margin-bottom: -8px; margin-top: -4px;" src="icons/divider.png" alt="map popup divider">';
			const img2 = '<img style="height:3px;width: 75%; display: block; margin-left: auto; margin-right: auto; margin-bottom: -14px; margin-top: -2px;" src="icons/divider_small.png" alt="map popup divider">';

			return `${titleLink}${img1}<i><font size="+0.5">${category}</font></i>${img2}<br />${description}`;
		}

		const regionMap = {
			"ar": "ar",
			"od": "ar",
			"th": "ar",
			"rh": "ar",
			"az": "ar",
			"ts": "ar",
			"pr": "ar",
			"dr": "ar",
			"tc": "ar",
			"gi": "ar",
			"ac": "ar",
		};

		function generateMarker(id, title, category, icon, description, linkEnabled, linkTitle, coords, customId) {
			coords = coords.replace('LatLng','').replace('(','[').replace(')',']');

			var firstTitle = title.split(' ')[0].toLowerCase();
			var newId = `${id}_${customId || firstTitle}`;
			if (linkTitle)
				linkTitle = ", '" + linkTitle + "'";

			return `createAndAddMarker("${regionMap[id] || "mo"}", ${coords}, icons.${icon}, "${title}", "${newId.replace(",", "")}", generatePopupContent("${title}", "${category}", "${description}", ${linkEnabled}${linkTitle || ""}));`;
		}

		var southWest = L.latLng(-70, -170),
			northEast = L.latLng(70, 170),
			bounds = L.latLngBounds(southWest, northEast);

		//Creating the Map
		var map = L.map('map', {
			maxBounds: bounds,
			zoomSnap: 0.1,
			zoomDelta: 0.5,
			wheelPxPerZoomLevel: 120,
		}).setView([0, 0], 0);

		map.createPane('addPane');
		map.createPane('basePane');
		map.createPane('backgroundPane');

		map.getPane('addPane').style.zIndex = 250;
		map.getPane('basePane').style.zIndex = 220;
		map.getPane('backgroundPane').style.zIndex = 150;

		function createMap(title, noWrap, minZoom, maxZoom, pane, add) {
			// Create the tile layer
			let tileLayer = L.tileLayer(`maps/${title}/{z}/{x}/{y}.png`, {
				continuousWorld: false,
				noWrap: noWrap,
				minZoom: minZoom,
				maxZoom: maxZoom,
				pane: pane,
			});

			// Conditionally add the tile layer to the map
			if (add) {
				tileLayer.addTo(map);
			}

			return tileLayer;
		}

		function createIcon(icon, shadow, iconSize, iconAnchor, popupAnchor) {
			return L.icon({
				iconUrl: `icons/${icon}.png`,
				iconRetinaUrl: `icons/${icon}.png`,
				shadowUrl: `icons/${shadow}.png`,
				iconSize: iconSize,
				iconAnchor: iconAnchor,
				popupAnchor: popupAnchor,
				tooltipAnchor: [16, -28],
				shadowSize: [41, 41],
				className: icon
			});
		}

		// Maps
		var arathia = createMap('arathia', true, 2.75, 5.4, 'basePane', true);
		var arathiaClean = createMap('arathiaClean', true, 2.75, 5.4, 'basePane', false);
		var Test = createMap('morturia', true, 2.75, 5.4, 'addPane', false);
		var Test2 = createMap('morturia', true, 2.75, 5.4, 'addPane', false);
		var morturia = createMap('morturia', true, 2.75, 5.4, 'basePane', false);
		var arathiaBackground = createMap('arathiaBackground', false, 2.75, 5.4, 'backgroundPane', true);
		var morturiaBackground = createMap('morturiaBackground', false, 2.75, 5.4, 'backgroundPane', false);

		// Icons Settings: { size = image size, anchor = where on the image is on the coordinate, popupAnchor = where the popup will be anchored to the marker }
		var defaultIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var oldIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var simpleIconSettings = { size: [31, 41], anchor: [15, 25], popupAnchor: [1, -22] };

		function adjustSettings(defaultSettings, adjustments) {
			return {
				size: adjustments.size ? [defaultSettings.size[0] + adjustments.size[0], defaultSettings.size[1] + adjustments.size[1]] : defaultSettings.size,
				anchor: adjustments.anchor ? [defaultSettings.anchor[0] + adjustments.anchor[0], defaultSettings.anchor[1] + adjustments.anchor[1]] : defaultSettings.anchor,
				popupAnchor: adjustments.popupAnchor ? [defaultSettings.popupAnchor[0] + adjustments.popupAnchor[0], defaultSettings.popupAnchor[1] + adjustments.popupAnchor[1]] : defaultSettings.popupAnchor
			};
		}

		// Icons
		var icons = {
			capital: createIcon('capital', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			cityBig: createIcon('cityBig', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			citySmall: createIcon('citySmall', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			town: createIcon('town', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			nature: createIcon('nature', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			important: createIcon('important', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			character: createIcon('character', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
	
			capitalOld: createIcon('capitalOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			cityBigOld: createIcon('cityBigOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			citySmallOld: createIcon('citySmallOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			townOld: createIcon('townOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			natureOld: createIcon('natureOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			importantOld: createIcon('importantOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			characterOld: createIcon('characterOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),

			capitalSimple: createIcon('capitalSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			cityBigSimple: createIcon('cityBigSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor),
			citySmallSimple: createIcon('citySmallSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 4] }).popupAnchor),
			townSimple: createIcon('townSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 6] }).popupAnchor),
			natureSimple: createIcon('natureSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 8] }).popupAnchor),
			importantSimple: createIcon('importantSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			characterSimple: createIcon('characterSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor)
		}

		//Coordinate Finder
		var marker = L.marker([0, 0], {
			draggable: true,
		}).on('dragend', function() {
			marker.openPopup();
			markerMaker();
		});

		function markerMaker() {
			// Load saved data
			loadFormData();

			var coords = marker.getLatLng().toString().replace('LatLng', '').replace('(', '').replace(')', '');
			document.getElementById('Coords').value = coords;

			// Add event listeners for each form element
			var formElements = document.querySelectorAll('#Id, #Title, #Category, #Description, #Link, #LinkText, #CustomId');
			formElements.forEach(function(element) {
				element.addEventListener('change', saveFormData);
			});

			document.getElementById('DevButton').addEventListener('click', function() {
				// Get form data
				var formData = getFormData();
				var output = generateMarker(formData.id, formData.title, formData.category, formData.icon, formData.description, formData.linkEnabled, formData.linkTitle, formData.coords, formData.customId);

				// Display the output
				document.getElementById('Output').value = output;
			});

			window.onbeforeunload = function() {
				localStorage.removeItem('markerFormData');
			};
		}

		// Get form data
		function getFormData() {
			return {
				id: document.getElementById('Id').value,
				title: document.getElementById('Title').value,
				icon: document.getElementById('Category').value,
				category: document.getElementById('Category').options[document.getElementById('Category').selectedIndex].id,
				description: document.getElementById('Description').value,
				linkEnabled: document.getElementById('Link').checked,
				linkTitle: document.getElementById('LinkText').value,
				customId: document.getElementById('CustomId').value,
				coords: marker.getLatLng().toString()
			};
		}

		// Save form data to localStorage
		function saveFormData() {
			var formData = getFormData();
			localStorage.setItem('markerFormData', JSON.stringify(formData));
		}

		// Load form data from localStorage
		function loadFormData() {
			var savedData = localStorage.getItem('markerFormData');
			if (savedData) {
				savedData = JSON.parse(savedData);
				document.getElementById('Id').value = savedData.id;
				document.getElementById('Title').value = savedData.title;
				document.getElementById('Category').value = savedData.icon;
				document.getElementById('Description').value = savedData.description;
				document.getElementById('Link').checked = savedData.linkEnabled;
				document.getElementById('LinkText').value = savedData.linkTitle;
				document.getElementById('CustomId').value = savedData.customId;
			}
		}

		var formHTML = `
			<div class="custom-container">
				<span class="custom-title"><font size="+0.5">Marker Maker</font></span>
				<span class="custom-subtitle"><font size="-1">Coords</font></span>
				<input class="custom-input" type="text" id="Coords" placeholder="Coords"></input>
				<img style="height:3px;width: 100%; display: block; margin-left: auto; margin-right: auto; margin-bottom: 0px; margin-top: 0px;" src="icons/divider_small.png" alt="map popup divider">
				<span class="custom-subtitle"><font size="-1">Country</font></span>
				<select class="custom-select" name="Id" id="Id">
					<option value="ar">Antaria</option>
					<option value="od">Odrheim</option>
					<option value="th">Tunglheimr</option>
					<option value="rh">Rheinland</option>
					<option value="az">Azurith</option>
					<option value="ts">Tsuki</option>
					<option value="pr">Primoria</option>
					<option value="dr">Dryadalis</option>
					<option value="tc">Trade Company</option>
					<option value="gi">Gigantoria</option>
					<option value="ac">Arcarum</option>
					<option disabled>─────────────────────────</option>
					<option value="ad">Ardeat</option>
					<option value="ge">Gelida</option>
					<option value="sc">Scientia</option>
				</select>
				<input class="custom-input" type="text" id="Title" placeholder="Title"></input>
				<span class="custom-subtitle"><font size="-1">Category</font></span>
				<select class="custom-select" name="Category" id="Category">
					<option value="capital" id="Capital">Capital</option>
					<option value="citiesBig" id="Big City">Big City</option>
					<option value="citiesSmall" id="Small City">Small City</option>
					<option value="towns"id="Town">Town</option>
					<option disabled>─────────────────────────</option>
					<option value="nature" id="Forest">Forest</option>
					<option value="nature" id="Mountain">Mountain</option>
					<option value="nature" id="Cave">Cave</option>
					<option disabled>─────────────────────────</option>
					<option value="important" id="Important Location">Important Location</option>
					<option value="important" id="Historical Location">Historical Location</option>
					<option disabled>─────────────────────────</option>
					<option value="characters" id="Character">Character</option>
					</select>
				<input class="custom-input" type="text" id="Description" placeholder="Description"></input>
				<div class="custom-checkbox-container">
					<input class="custom-checkbox" type="checkbox" id="Link">
					<label for="Link">Link?</label>
				</div>
				<input class="custom-input" type="text" id="LinkText" placeholder="Custom link text (optional)"></input>
				<input class="custom-input" type="text" id="CustomId" placeholder="Custom id name (optional)"></input>
				<button class="custom-button" id="DevButton">Generate</button>
				<input class="custom-input" type="text" id="Output" placeholder="Output"></input>
			</div>
			`;

		marker.bindPopup(formHTML).openPopup();
		marker.on('click', function(e) {
			markerMaker();
		});

		var regionLayerGroups = {
			'ar': {
				'capital': L.layerGroup().addTo(map),
				'cityBig': L.layerGroup().addTo(map),
				'citySmall': L.layerGroup().addTo(map),
				'town': L.layerGroup().addTo(map),
				'nature': L.layerGroup().addTo(map),
				'important': L.layerGroup().addTo(map),
				'character': L.layerGroup().addTo(map)
			},
			'mo': {
				'capital': L.layerGroup(),
				'cityBig': L.layerGroup(),
				'citySmall': L.layerGroup(),
				'town': L.layerGroup(),
				'nature': L.layerGroup(),
				'important': L.layerGroup(),
				'character': L.layerGroup()
			},
		};

		// Print all console commands
		function help() {
			console.log(`
			All availible commands:
			openAllPopupsInLayerGroup(region, group); Opens all of the popups you want
			closeAllPopups(); Closes all open popups
			printRegionGroups(); Prints all region Groups
			`);
		}

		function printRegionGroups() {
			// Iterate over each key in the regionLayerGroups object
			for (const region in regionLayerGroups) {
				// Check if the property is actually part of the object and not inherited
				if (regionLayerGroups.hasOwnProperty(region)) {
					// Get the sub-object for this region
					const group = regionLayerGroups[region];
					// Iterate over each key in the sub-object
					for (const key in group) {
						// Check if the property is actually part of the sub-object and not inherited
						if (group.hasOwnProperty(key)) {
							// Print the region and key in the desired format
							console.log(`${region}, ${key}`);
						}
					}
				}
			}
		}

		// Run from the console, openAllPopupsInLayerGroup(ar, cityBig);
		function openAllPopupsInLayerGroup(region, group) {
			if (regionLayerGroups[region] && regionLayerGroups[region][group]) {
				var layerGroup = regionLayerGroups[region][group];

				layerGroup.eachLayer(function(layer) {
					if (layer instanceof L.Marker && layer.getPopup()) {
						// Create a non-closable popup and bind it to the marker
						var nonClosablePopup = L.popup({ autoClose: false, closeOnClick: false }).setContent(layer.getPopup().getContent());
						layer.bindPopup(nonClosablePopup);

						// Open the popup
						layer.openPopup();
					}
				});
			} else {
				console.log("Invalid region or group");
			}
		}

		// Run from the console
		function closeAllPopups() {
			// Iterate through each region in the regionLayerGroups
			for (var region in regionLayerGroups) {
				if (regionLayerGroups.hasOwnProperty(region)) {
					// Iterate through each group in the region
					for (var group in regionLayerGroups[region]) {
						if (regionLayerGroups[region].hasOwnProperty(group)) {
							var layerGroup = regionLayerGroups[region][group];

							// Close popup of each layer in the group
							layerGroup.eachLayer(function(layer) {
								if (layer instanceof L.Marker) {
									layer.closePopup();
								}
							});
						}
					}
				}
			}
		}

		function createAndAddMarker(region, coords, icon, title, id, popupContent) {
			var marker = L.marker(coords, { icon: icon, title: title, id: id }).bindPopup(popupContent);

			// Automatically add the marker to the correct group based on icon
			if (regionLayerGroups[region] && regionLayerGroups[region][icon.options.className]) {
				regionLayerGroups[region][icon.options.className].addLayer(marker);
			}

			return marker;
		}
		
		//Arathia	
		//Antaria
		createAndAddMarker('ar', [32.720989, -41.187598], icons.capital, 'Antaria', 'an_capital', generatePopupContent('Antaria', 'Capital', 'The capital of the Holy Antarian Enpire', true));
		//Locations
		createAndAddMarker('ar', [45.04985, -79.242103], icons.important, 'Antarian Arch-Tree', 'an_archtree', generatePopupContent('Antarian Arch-Tree', 'Important Location', '', true, 'Arch-Trees'));
		//Big Cities
		createAndAddMarker('ar', [12.640338, -35.859375], icons.cityBig, 'Antarian Port City', 'an_city', generatePopupContent('Antarian Port City', 'Large City', 'A trade city in the HAE with a large port', false));
		//Small Cities
		//Towns
		createAndAddMarker('ar', [-1.841265, -73.559396], icons.town, 'Antarian Town', 'an_town', generatePopupContent('Antarian Town', 'Town', '', false));
		createAndAddMarker('ar', [18.293698, -115.356925], icons.town, 'Antarian Town', 'an_town2', generatePopupContent('Antarian Town', 'Town', '', false));
		//Nature
		createAndAddMarker('ar', [27.302636, -81.285998], icons.nature, 'Antarian Mountain Range', 'ar_mountain', generatePopupContent('Antarian Mountain Range', 'Mountain', 'The largest mountain range in Antaria', false));

		//Odrheim
		createAndAddMarker('ar', [46.588506, 33.414077], icons.capital, 'Odrheim Capital', 'od_capital', generatePopupContent('Odrheim Capital', 'Capital', 'The capital of Odrheim', false));
		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Tunglheimr
		createAndAddMarker('ar', [41.364997, 70.145929], icons.capital, 'Tungleheimr Capital', 'th_capital', generatePopupContent('Tungleheimr Capital', 'Capital', 'The capital of Tunglheimr', false));
		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature
		
		//Rheinland
		createAndAddMarker('ar', [15.641359, 138.427261], icons.capital, 'Rheinland Capital', 'rh_capital', generatePopupContent('Rheinland Capital', 'Capital', 'The capital of Rheinland', false));
		//Locations
		createAndAddMarker('ar', [27.803884, 131.965833], icons.important, 'Rheinland Arch-Tree', 'rh_archtree', generatePopupContent('Rheinland Arch-Tree', 'Important Location', '', true, 'Arch-Trees'));
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Golden Order

		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Azurith
		createAndAddMarker('ar', [-23.271278, 104.100923], icons.capital, 'Azurith Capital', 'az_capital', generatePopupContent('Azurith Capital', 'Capital', 'The capital of Azurith', false));
		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Tsuki
		createAndAddMarker('ar', [-26.786247, 10.234271], icons.capital, 'Getsuyōsei', 'ts_capital', generatePopupContent('Getsuyōsei', 'Capital', "Getsuyōsei, Tsuki Ōkoku's capital, glows with a blend of heritage and harmony. Pagodas reflect the moon's gleam, while the lunar fountain and moon-phase banners add to the city's vibrance. Local flavors and music enliven markets, and serene temples honor the moon goddess. The observatory highlights the kingdom's celestial connection.", true));
		//Locations
		createAndAddMarker('ar', [-17.677522, 10.600598], icons.important, 'Tsuki Arch-Tree', 'ts_archtree', generatePopupContent('Tsuki Arch-Tree', 'Important Location', 'The Arch-Tree located in the city Getsuyōsei, blossoming in a beautiful blue color.', true, 'Arch-Trees'));
		createAndAddMarker('ar', [-52.329725, 58.377932], icons.important, 'Mizu-no-Iwaya', 'ts_mizunoiwaya', generatePopupContent('Mizu-no-Iwaya', 'Important Location', 'The cave where the first Gekkōjin “Tsukikage Genjiro” sought enlightenment.', false));
		//Big Cities
		createAndAddMarker('ar', [-13.88388, 37.332231], icons.cityBig, 'Sōgenshima', 'ts_sōgenshima', generatePopupContent('Sōgenshima', 'Large City', '', false));
		createAndAddMarker('ar', [-34.127172, -11.480145], icons.cityBig, 'Kinshū', 'ts_kinshū', generatePopupContent('Kinshū', 'Large City', 'A trading city, main trading partners are Trade Company and Primoria.', false));
		createAndAddMarker('ar', [-50.232027, 66.709798], icons.cityBig, 'Hikari no Toshi', 'ts_hikari', generatePopupContent('Hikari no Toshi', 'Large City', '', false));
		//Small Cities
		createAndAddMarker('ar', [-32.556313, 28.080238], icons.citySmall, 'Amagumo', 'ts_amagumo', generatePopupContent('Amagumo', 'Small City', 'Nestled in the mountainous regions, known for its misty weather and skilled artisans who work with rare minerals and mountain resources.', false));
		createAndAddMarker('ar', [-60.418733, 26.314855], icons.citySmall, 'Yozora', 'ts_yozora', generatePopupContent('Yozora', 'Small City', "Located in a remote area, known for its tranquil nights and a community deeply connected to nature, focusing on agriculture and stargazing.", false));
		createAndAddMarker('ar', [-17.927417, 65.51944], icons.citySmall, 'Kōun', 'ts_kōun', generatePopupContent('Kōun', 'Small City', 'A prosperous city that benefits from nearby trade routes, known for its wealth and the influential merchants that reside there.', false));
		createAndAddMarker('ar', [-35.440072, 48.867281], icons.citySmall, 'Shingetsu', 'ts_shingetsu', generatePopupContent('Shingetsu', 'Small City', 'A city that thrives under the light of the moon, famous for its observatory and scholars devoted to the study of celestial bodies and timekeeping.', false));
		createAndAddMarker('ar', [-46.037499, 15.928128], icons.citySmall, 'Engetsu', 'ts_engetsu', generatePopupContent('Engetsu', 'Small City', 'Situated by a river, this city is a hub for fishermen and traders, renowned for its bustling fish markets and intricate waterways.', false));
		createAndAddMarker('ar', [-40.933431, 81.082085], icons.citySmall, 'Tsukimiya', 'ts_tsukimiya', generatePopupContent('Tsukimiya', 'Small City', "Positioned strategically for trade, it's a melting pot of cultures, with busy markets offering exotic goods from distant lands.", false));
		//Towns
		createAndAddMarker('ar', [-1.52557, 55.842131], icons.town, 'Asahi', 'ts_asahi', generatePopupContent('Asahi', 'Town', "This modest town has a disproportionately large military outpost, crucial for coastal defense due to its proximity to the Holy Antarian Empire's border. The local populace is accustomed to the presence of soldiers and supports the garrison with fishing and repairs.", false));
		createAndAddMarker('ar', [-38.316604, 56.327448], icons.town, 'Yūnagi', 'ts_yūnagi', generatePopupContent('Yūnagi', 'Town', "Tucked away in the mountains, Haruka is a small mining community. Its remote location makes it a quiet town, where most families are involved in the mining industry or supporting trades like blacksmithing.", false));
		createAndAddMarker('ar', [-50.561846, 25.966938], icons.town, 'Tsukiakari', 'ts_tsukiakari', generatePopupContent('Tsukiakari', 'Town', "A town with a deep spiritual connection to the moon, Tsukiakari celebrates lunar events. Its small community is known for its night markets and observatory, which attracts a few curious travelers.", false));
		createAndAddMarker('ar', [-55.861359, 44.071459], icons.town, 'Suzuran', 'ts_suzuran', generatePopupContent('Suzuran', 'Town', "Lying along a lake, Yūnagi is a quaint town whose markets are lively during trading seasons. It's a place where local farmers and craftsmen exchange goods with traveling merchants.", false));
		createAndAddMarker('ar', [-40.044885, 3.08464], icons.town, 'Yūdachi', 'ts_yūdachi', generatePopupContent('Yūdachi', 'Town', "This town is known for its sudden evening showers that support its rich agriculture. Residents have adapted to quickly changing weather, and it has a tight-knit community known for its resilience.", false));
		createAndAddMarker('ar', [-31.507445, 69.976505], icons.town, 'Haruka', 'ts_haruka', generatePopupContent('Haruka', 'Town', 'A town lying in the valley between the Yama no Kyōfū and ??? mountains.', false));
		createAndAddMarker('ar', [-62.13469, 65.332354], icons.town, 'Kōri', 'ts_kōri', generatePopupContent('Kōri', 'Town', "A chilly town known for its ice fields in the winter and a small community specializing in crafting from ice and snow, like sculptors and builders who create homes designed to retain warmth.", false));
		//Nature
		createAndAddMarker('ar', [-52.306608, 37.804889], icons.nature, 'Hanabira Nagare', 'ts_hanabira', generatePopupContent('Hanabira Nagare', 'Lake', '', false));
		createAndAddMarker('ar', [-36.031332, 57.919922], icons.nature, 'Yama no Kyōfū', 'ts_yama', generatePopupContent('Yama no Kyōfū', 'Mountain', 'The largest mountain range in Tsuki Ōkoku', false));
		createAndAddMarker('ar', [-30.524413, 37.705078], icons.nature, 'Gekkōzan', 'ts_gekkōzan', generatePopupContent('Gekkōzan', 'Mountain', '', false));
		createAndAddMarker('ar', [-16.910568, 0.642627], icons.nature, 'Hikari no Mori', 'ts_hikarinomori', generatePopupContent('Hikari no Mori', 'Forest', '', false));
		createAndAddMarker('ar', [-50.176898, 50.712891], icons.nature, 'Mizu Hanabira no Mori', 'ts_mizuhanabira', generatePopupContent('Mizu Hanabira no Mori', 'Forest', '', false));
		createAndAddMarker('ar', [-18.452263, 32.228559], icons.nature, 'Tsukiakari', 'ts_tsukiakari', generatePopupContent('Tsukiakari', 'Forest', '', false));
		createAndAddMarker('ar', [-63.726971, 54.595624], icons.nature, 'Kōri Kaisen', 'ts_kori', generatePopupContent('Kōri Kaisen', 'Shore', '', false));

		//Primoria
		createAndAddMarker('ar', [-26.181457, -61.49786], icons.capital, 'Primorian Capital', 'pr_capital', generatePopupContent('Primorian Capital', 'Capital', 'The capital of Primoria', false));
		//Locations
		createAndAddMarker('ar', [-54.521081, -69.169922], icons.important, 'Primorian Arch-Tree', 'pr_archtree', generatePopupContent('Primorian Arch-Tree', 'Important Location', 'The Arch-Tree in Primoria', true, 'Arch-Trees'));
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Dryadalis
		createAndAddMarker('ar', [-39.842286, -136.933594], icons.capital, 'Aeternum', 'dr_capital', generatePopupContent('Aeternum', 'Capital ', 'The capital of Dryadalis', false));
		//Locations
		//Big Cities
		createAndAddMarker('ar', [-51.123378, -128.277507], icons.cityBig, 'Eldorath', 'dr_eldorath', generatePopupContent('Eldorath', 'Large City', '', false));
		//Small Cities
		createAndAddMarker('ar', [-49.111661, -155.112608], icons.citySmall, 'Faerwyn', 'dr_faerwyn', generatePopupContent('Faerwyn', 'Small City', '', false));
		//Towns
		createAndAddMarker('ar', [-46.664566, -142.44974], icons.town, 'Elaris', 'dr_elaris', generatePopupContent('Elaris', 'Town', '', false));
		createAndAddMarker('ar', [-57.328012, -139.768383], icons.town, 'Galadrim', 'dr_galadrim', generatePopupContent('Galadrim', 'Town', '', false));
		//Nature
		createAndAddMarker('ar', [-41.435969, -150.186067], icons.nature, 'Feywood', 'dr_feywood', generatePopupContent('Feywood', 'Forest', '', false));
		createAndAddMarker('ar', [-49.323654, -150.75126], icons.nature, 'Lacus Serenus', 'dr_lacus', generatePopupContent('Lacus Serenus', 'Lake', '', false));
		createAndAddMarker('ar', [-42.875964, -142.119141], icons.nature, 'Verdantis Mons', 'dr_verdantis', generatePopupContent('Verdantis Mons', 'Mountain', '', false));

		//Trade Company

		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Gigantoria

		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Arcarum 

		//Locations
		//Big Cities
		//Small Cities
		//Towns
		//Nature

		//Oceans

		//Characters
		createAndAddMarker('ar', [-2.372369, -72.685547], icons.character, 'Gerhard von Eichenwald', 'an_gerhard', generatePopupContent('Gerhard von Eichenwald', 'Character', 'Gerhards temporary camp in a small town in the Holy Antarian Empire', true, ));
		createAndAddMarker('ar', [-41.980887, 32.348339], icons.character, 'Nihil, the Eternal', 'ts_nihil', generatePopupContent('Nihil, the Eternal', 'Character ', 'Currently in hiding after the great dragon purge.', true));
		createAndAddMarker('ar', [17.768594, -114.376119], icons.character, 'Aurumoria, the Gilded Guardian', 'an_aurumoria', generatePopupContent('Aurumoria, the Gilded Guardian', 'Character ', 'Currently in hiding in a small town after the great dragon purge, has taken human form to blend in.', true));
		createAndAddMarker('ar', [-25.403585, 12.744141], icons.character, 'Miyamoto Reiko', 'ts_reiko', generatePopupContent('Miyamoto Reiko', 'Character', 'The current leader of Tsuki Ōkoku', true));

		//Morturia
		//Scientia
		createAndAddMarker('mo', [39.994442, 89.15887], icons.capital, 'Scienta Capital', 'sc_capital', generatePopupContent('Scienta Capital', 'Capital', 'The capital of Scientia', false));
		//Locations"

		//Ardeat
		
		//Locations

		//Gelida
		
		//Locations

		//Characters

		//Marker Groups
		var ar_all_layers = L.layerGroup([regionLayerGroups['ar']['capital'], regionLayerGroups['ar']['cityBig'], regionLayerGroups['ar']['citySmall'], regionLayerGroups['ar']['town'], regionLayerGroups['ar']['nature'], regionLayerGroups['ar']['important'], regionLayerGroups['ar']['character']]);

		var mo_all_layers = L.layerGroup([regionLayerGroups['mo']['capital'], regionLayerGroups['mo']['cityBig'], regionLayerGroups['mo']['citySmall'], regionLayerGroups['mo']['town'], regionLayerGroups['mo']['nature'], regionLayerGroups['mo']['important'], regionLayerGroups['mo']['character']]);
		
		var dv_coord = L.layerGroup([marker]);
		
		//Marker Overlay
		var overlays = {
			"Arathia": {
				"Capitals": regionLayerGroups['ar']['capital'],
				"Large Cities": regionLayerGroups['ar']['cityBig'],
				"Small Cities": regionLayerGroups['ar']['citySmall'],
				"Towns": regionLayerGroups['ar']['town'],
				"Nature": regionLayerGroups['ar']['nature'],
				"Locations": regionLayerGroups['ar']['important'],
				"Characters": regionLayerGroups['ar']['character'],
			},
			"Morturia": {
				"Capitals": regionLayerGroups['mo']['capital'],
				"Large Cities": regionLayerGroups['mo']['cityBig'],
				"Small Cities": regionLayerGroups['mo']['citySmall'],
				"Towns": regionLayerGroups['mo']['town'],
				"Nature": regionLayerGroups['mo']['nature'],
				"Locations": regionLayerGroups['mo']['important'],
				"Characters": regionLayerGroups['mo']['character'],
			},
			"Developer": {
				"Marker Maker": dv_coord,
			}
		};
		var options = {
			groupCheckboxes: true
		};
		var mapLayers = {
			"Arathia": arathia,
			"Arathia Clean": arathiaClean,
			"Morturia": morturia,
		}

		//GROUP CONTROLS
		L.control.groupedLayers(mapLayers, overlays, options).addTo(map);

		var controlSearchAr = new L.Control.Search({
			position:'topleft',		
			layer: ar_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});
		var controlSearchMo = new L.Control.Search({
			position:'topleft',		
			layer: mo_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});

		map.addControl( controlSearchAr );

		var iconChecked = 1;
		var currentMap = 'Arathia';

		function updateMapStyles(map, backgroundColor, addControl, removeControl) {
			map.getContainer().style.backgroundColor = backgroundColor;
			map.addControl(addControl);
			map.removeControl(removeControl);
		}

		function updateLayers(map, addLayers, removeLayers) {
			removeLayers.forEach(layer => map.removeLayer(layer));
			addLayers.forEach(layer => map.addLayer(layer));
		}

		function updateCheckbox(selectorIndex, checked) {
			var checkbox = document.querySelectorAll('.leaflet-control-layers-group-selector')[selectorIndex];
			checkbox.checked = checked;
		}

		function getTrimmedText(node) {
			return node.nextSibling.textContent.trim();
		}

		function hideCheckBoxes(groupNumber) {
			var elementId = 'leaflet-control-layers-group-' + groupNumber;
			var element = document.getElementById(elementId);
			if (element) {
				element.parentNode.removeChild(element);
			} else {
				console.log('Element with id ' + elementId + ' not found.');
			}
		}

		document.addEventListener('change', function (event) {
			var radioButton = event.target;

			if (radioButton.classList.contains('leaflet-control-layers-selector')) {
				currentMap = getTrimmedText(radioButton);
				switch (currentMap) {
					case 'Arathia':
						updateMapStyles(map, '#31565a', controlSearchAr, controlSearchMo);
						updateLayers(map, [ar_all_layers, arathiaBackground], [mo_all_layers, morturiaBackground]);
						updateCheckbox(0, true);
						hideCheckBoxes(2);
						addRadioButtons(iconChecked);
						if (currentSelectedMap != arathia) {
							map.removeLayer(currentSelectedMap);
						}
						selectedOptionId = 'arOption1'
						addYearSelect();
						document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
						setYearSelectorToLastDropdown();
						console.log("Changed selected map");
						break;
					case 'Arathia Clean':
						updateMapStyles(map, '#31565a', controlSearchAr, controlSearchMo);
						updateLayers(map, [arathiaBackground], [mo_all_layers, ar_all_layers, morturiaBackground]);
						updateCheckbox(0, false);
						hideCheckBoxes(2);
						addRadioButtons(iconChecked);
						if (currentSelectedMap != arathiaClean) {
							map.removeLayer(currentSelectedMap);
						}
						selectedOptionId = 'arCleanOption1'
						addYearSelect();
						document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
						setYearSelectorToLastDropdown();
						console.log("Changed selected map");
						break;
					case 'Morturia':
						updateMapStyles(map, '#374539', controlSearchMo, controlSearchAr);
						updateLayers(map, [mo_all_layers, morturiaBackground], [ar_all_layers, arathiaBackground]);
						updateCheckbox(1, true);
						hideCheckBoxes(1);
						addRadioButtons(iconChecked);
						addYearSelect();
						document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
						setYearSelectorToLastDropdown();
						console.log("Changed selected map");
						break;
					case 'Morturia Clean':
						updateMapStyles(map, '#374539', controlSearchMo, controlSearchAr);
						updateLayers(map, [morturiaBackground], [mo_all_layers, ar_all_layers, arathiaBackground]);
						updateCheckbox(1, false);
						hideCheckBoxes(1);
						addRadioButtons(iconChecked);
						addYearSelect();
						document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
						setYearSelectorToLastDropdown();
						console.log("Changed selected map");
						break;
				}
			} else if (radioButton.classList.contains('custom-radio-class')) {
				var iconMap = {
					'Default Icons': 1,
					'Old Icons': 2,
					'Simple Icons': 3
				};
				var iconType = getTrimmedText(radioButton);
				if (iconMap.hasOwnProperty(iconType)) {
					iconChecked = iconMap[iconType];
					updateIcons(currentMap, iconChecked);
				}
			}
		});

		var oldSuffix = "";

		var currentSelectedMap = arathia;

		const yearMap = {
			"arOption1": "arathia",
			"arOption2": "Test",
		};

		function changeMapToSelected() {
			console.log("Current map before switching:", currentSelectedMap);

			var dropdown = document.getElementById('YearSelector');
			var selectedOption = dropdown.options[dropdown.selectedIndex].id;

			switch(selectedOption) {
				case 'arOption1':
					if (currentSelectedMap != arathia) {
						map.removeLayer(currentSelectedMap);
					}
					arathia.addTo(map);
					currentSelectedMap = arathia;
					break;
				case 'arOption2':
					if (currentSelectedMap != arathia) {
						map.removeLayer(currentSelectedMap);
					} 
					Test.addTo(map);
					currentSelectedMap = Test;
					break;
				case 'arOption3':
					if (currentSelectedMap != arathia) {
						map.removeLayer(currentSelectedMap);
					} 
					Test2.addTo(map);
					currentSelectedMap = Test2;
					break;
				case 'arCleanOption1':
					if (currentSelectedMap != arathiaClean) {
						map.removeLayer(currentSelectedMap);
					}
					arathiaClean.addTo(map);
					currentSelectedMap = arathiaClean;
					break;
			}
			console.log("Changed map to: ", currentSelectedMap);
		}

		function changeAllIcons(suffix) {
			const layerGroups = [regionLayerGroups['ar']['capital'], regionLayerGroups['ar']['cityBig'], regionLayerGroups['ar']['citySmall'], regionLayerGroups['ar']['town'], regionLayerGroups['ar']['nature'], regionLayerGroups['ar']['important'], regionLayerGroups['ar']['character']];
			layerGroups.forEach(group => {
				const layers = group.getLayers();
				layers.forEach(layer => {
					var newIconName = layer.options.icon.options.className.replace(oldSuffix, '') + suffix;

					if (icons[newIconName]) {
						layer.options.icon = icons[newIconName];
					} else {
						console.error('Icon not found:', newIconName);
					}
				});
			});

			oldSuffix = suffix;
		}

		function updateCheckbox(selectorIndex, checked) {
			var arathiaCheckbox = document.querySelectorAll('.leaflet-control-layers-group-selector')[selectorIndex];
			arathiaCheckbox.checked = checked;
		}

		function updateIcons(currentMap, iconChecked) {
			const suffixMap = {1: '', 2: 'Old', 3: 'Simple'};
    		changeAllIcons(suffixMap[iconChecked] || '');

			switch (currentMap) {
				case 'Arathia':
					map.removeLayer(ar_all_layers);
					map.addLayer(ar_all_layers);
					updateCheckbox(0, true)
					hideCheckBoxes(3);
					break;
				case 'Arathia Clean':
					map.addLayer(ar_all_layers);
					map.removeLayer(ar_all_layers);
					updateCheckbox(0, false)
					hideCheckBoxes(3);
					break;
				case 'Morturia':
					map.removeLayer(mo_all_layers);
					map.addLayer(mo_all_layers);
					updateCheckbox(2, true)
					hideCheckBoxes(1);
					break;
				case 'Morturia Clean':
					map.addLayer(mo_all_layers);
					map.removeLayer(mo_all_layers);
					updateCheckbox(2, false)
					hideCheckBoxes(1);
					break;
			}
			addRadioButtons(iconChecked)
			addYearSelect();
			document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
			setYearSelectorToLastDropdown();
			changeMapToSelected();
			console.log("Changed selected map");
		}

		document.addEventListener('DOMContentLoaded', function () {
			// Check the main checkbox
			var checkbox = document.querySelector('.leaflet-control-layers-group-selector');
			checkbox.checked = true;
			addRadioButtons(1)
			hideCheckBoxes(2);
			addYearSelect();
			document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
		});

		var selectedOptionId = 'arOption1';

		function addYearSelect() {
			// Find the checked radio button
			var checkedRadioButton = document.querySelector('.leaflet-control-layers-base input[type="radio"]:checked');
			var label = checkedRadioButton.nextElementSibling;

			// Create the dropdown box
			var dropdown = document.createElement('select');
			dropdown.name = 'options';
			dropdown.id = "YearSelector";
			dropdown.className = 'custom-select';

			// Add options to the dropdown
			if (label && label.textContent == " Arathia") {
				createSelect("1257 A.A", "arOption1", dropdown);
				createSelect("67 B.A", "arOption2", dropdown);
				createSelect("517 B.R", "arOption3", dropdown); 
			} else if (label && label.textContent == " Morturia") {
				createSelect("1257 A.A", "moOption1", dropdown);
				createSelect("???", "moOption2", dropdown); 
			} else if (label && label.textContent == " Arathia Clean") {
				createSelect("1257 A.A", "arCleanOption1", dropdown);
				createSelect("67 B.A", "arCleanOption2", dropdown);
				createSelect("517 B.R", "arCleanOption3", dropdown); 
			}

			// Insert the dropdown after the parent label of the checked radio button
			checkedRadioButton.closest('label').after(dropdown);
		}

		function createSelect(year, optionId, dropdown) {
			var option = document.createElement('option');
			option.id = optionId; // Use the optionId parameter
			option.textContent = year;
			dropdown.appendChild(option);
		}

		// Function to update the variable with the selected option's ID
		function updateSelectedOptionId() {
			var dropdown = document.getElementById('YearSelector');
			selectedOptionId = dropdown.options[dropdown.selectedIndex].id;
			console.log("Selected Option ID:", selectedOptionId); // For demonstration
			changeMapToSelected();
			console.log("Changed selected map");
		}

		function setYearSelectorToLastDropdown() {
			var dropdown = document.getElementById('YearSelector');
    
			// Check if the dropdown has options
			if (dropdown.options.length > 0) {
				// Find the option that matches the selectedOptionId
				var matchingOptionExists = Array.from(dropdown.options).some(option => option.id === selectedOptionId);

				if (matchingOptionExists) {
					// Set the dropdown's value to the matching option's value
					for (var i = 0; i < dropdown.options.length; i++) {
						if (dropdown.options[i].id === selectedOptionId) {
							dropdown.selectedIndex = i;
							console.log("Dropdown set to option with ID:", selectedOptionId);
							break;
						}
					}
				} else {
					console.log('Matching option not found in the dropdown.');
					if (currentSelectedMap != arathia) {
						map.removeLayer(currentSelectedMap);
					}
					selectedOptionId = '';
				}
			} else {
				console.log('The dropdown has no options.');
			}
		}

		// Wait for the DOM to be ready
		function addRadioButtons(checked) {
			// Simplified createRadioButton function
			function createRadioButton(label, value, isChecked) {
				var radio = document.createElement("input");
				radio.type = "radio";
				radio.name = "layerSelector";
				radio.value = value;
				radio.checked = isChecked; // Direct assignment
				radio.classList.add("custom-radio-class");

				var labelElement = document.createElement("label");
				labelElement.appendChild(radio);
				labelElement.appendChild(document.createTextNode(label));
				return labelElement;
			}

			// Get the overlay control container
			var overlayContainer = document.querySelector('.leaflet-control-layers-overlays');

			// Create and append the separator div
			var separatorDiv = document.createElement("div");
			separatorDiv.classList.add("leaflet-control-layers-separator");
			overlayContainer.appendChild(separatorDiv);

			// Radio buttons information
			var radioButtonsInfo = [
				{ label: "Default Icons", option: "option1", checkedIndex: 1 },
				{ label: "Old Icons", option: "option2", checkedIndex: 2 },
				{ label: "Simple Icons", option: "option3", checkedIndex: 3 }
			];

			// Loop to create and append radio buttons
			radioButtonsInfo.forEach(info => {
				var radioButton = createRadioButton(info.label, info.option, checked === info.checkedIndex);
				radioButton.classList.add("leaflet-control-layers-selector");
				overlayContainer.appendChild(radioButton);
			});
		};

		function createWikiButton() {
			const wikiButton = document.createElement('a');
			wikiButton.className = 'leaflet-control-zoom-out';
			wikiButton.href = 'wiki';
			wikiButton.target = '_blank';
			wikiButton.title = 'Wiki';
			wikiButton.role = 'button';
			wikiButton.style.cssText = 'display: flex; justify-content: center; align-items: center;';

			const img = document.createElement('img');
			img.src = 'icons/web1.png';
			img.style.cssText = 'max-width: 16px; max-height: 16px;';

			function toggleIcon(src) {
				img.src = src;
			}

			wikiButton.addEventListener('mouseenter', () => toggleIcon('icons/web2.png'));
			wikiButton.addEventListener('mouseleave', () => toggleIcon('icons/web1.png'));

			wikiButton.appendChild(img);
			return wikiButton;
		}

		const zoomControl = document.querySelector('.leaflet-control-zoom.leaflet-bar.leaflet-control');
		const wikiButton = createWikiButton();
		zoomControl.insertAdjacentElement('beforeend', wikiButton);

		document.getElementsByClassName('leaflet-control-attribution')[0].style.display = 'none';
	</script>		
</body>

</html>