<!DOCTYPE html>
<html = style="height: 100%;">

<head>
	<title>Arathia Cities Maps</title>
	<meta charset="UTF-8">
	<link rel="icon" href="icons/arathia.png">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="scripts/leaflet.css">
	<link rel="stylesheet" href="scripts/src/leaflet.groupedlayercontrol.css" />
	<link rel="stylesheet" href="scripts/leaflet-search/src/leaflet-search.css" />
	<link rel="stylesheet" href="style/style.css">
	<script src="scripts/leaflet.js"></script>
	<script src="scripts/src/leaflet.groupedlayercontrol.js"></script>
	<script src="scripts/leaflet-search/src/leaflet-search.js"></script>
</head>

<body style="height: 100%;margin: 0;overflow-y: hidden;overflow-x: hidden;">
	<div id="map" style="width: 100%; height: 100%; background: #27180d;"></div>
	<a class="leaflet-control-zoom-out" href="index" title="Zoom out" role="button"
        aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">−</span></a>
	<script src="scripts/custom-scripts.js"></script>
	<script type="text/javascript">
		// MAPS
		var radioButtonsInfo = [
			{ label: "Default Icons", option: "option1", checkedIndex: 1, suffix: '' },
			{ label: "Old Icons", option: "option2", checkedIndex: 2, suffix: 'Old' },
			{ label: "Simple Icons", option: "option3", checkedIndex: 3, suffix: 'Simple' }
		];

		var neededMaps = [
			antaria,
		];

		var oldSuffix = "";
		var currentSelectedMap = antaria;
		var selectedOptionId = 'anOption1';
		var iconChecked = 1;
		var currentMap = 'Antaria';

		// Define a map to convert between optionIds when switching map types
		var optionIdConversions = {
			'anOption2': 'anCleanOption2',
			'tsOption2': 'tsCleanOption2'
		};

		const regionMap = {
			"an": "an",
			"od": "od",
			"th": "th",
			"rh": "rh",
			"az": "az",
			"ts": "ts",
			"pr": "pr",
			"dr": "dr",
			"tc": "tc",
			"gi": "gi",
			"ac": "ac",
		};

		var southWest = L.latLng(-80, -185),
			northEast = L.latLng(80, 185),
			bounds = L.latLngBounds(southWest, northEast);

		//Creating the Map
		var map = L.map('map', {
			maxBounds: bounds,
			zoomSnap: 0.1,
			zoomDelta: 0.5,
			wheelPxPerZoomLevel: 120,
		}).setView([0, 0], 0);

		map.createPane('addPane');
		map.createPane('basePane');
		map.createPane('backgroundPane');

		map.getPane('addPane').style.zIndex = 250;
		map.getPane('basePane').style.zIndex = 220;
		map.getPane('backgroundPane').style.zIndex = 150;

		// Maps createMap(title, noWrap, minZoom, maxZoom, pane, add)
		var antaria = createMap('Antaria', 'antaria', true, 2, 5.4, 'basePane', true);
		var tsuki = createMap('Antaria', 'getsuyosei', true, 2, 5.4, 'basePane', false);

		// Icons Settings: { size = image size, anchor = where on the image is on the coordinate, popupAnchor = where the popup will be anchored to the marker }
		var defaultIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var oldIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var simpleIconSettings = { size: [31, 41], anchor: [15, 25], popupAnchor: [1, -22] };

		// Icons
		var icons = {
			capital: createIcon('capital', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			cityBig: createIcon('cityBig', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			citySmall: createIcon('citySmall', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			town: createIcon('town', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			nature: createIcon('nature', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			important: createIcon('important', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			character: createIcon('character', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
	
			capitalOld: createIcon('capitalOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			cityBigOld: createIcon('cityBigOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			citySmallOld: createIcon('citySmallOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			townOld: createIcon('townOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			natureOld: createIcon('natureOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			importantOld: createIcon('importantOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			characterOld: createIcon('characterOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),

			capitalSimple: createIcon('capitalSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			cityBigSimple: createIcon('cityBigSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor),
			citySmallSimple: createIcon('citySmallSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 4] }).popupAnchor),
			townSimple: createIcon('townSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 6] }).popupAnchor),
			natureSimple: createIcon('natureSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 8] }).popupAnchor),
			importantSimple: createIcon('importantSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			characterSimple: createIcon('characterSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor),

			defaultIcon: createIcon('marker-icon', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor)
		}

		var fileInput = createFileInput();

		var formHTML = `
			<div class="custom-container">
				<span class="custom-title"><font size="+0.5">Marker Maker</font></span>
				<span class="custom-subtitle"><font size="-1">Coords</font></span>
				<input class="custom-input" type="text" id="Coords" placeholder="Coords"></input>
				<img style="height:3px;width: 100%; display: block; margin-left: auto; margin-right: auto; margin-bottom: 0px; margin-top: 0px;" src="icons/divider_small.png" alt="map popup divider">
				<span class="custom-subtitle"><font size="-1">Country</font></span>
				<select class="custom-select" name="Id" id="Id">
					<option value="ac">Arcarum</option>
					<option value="an">Antaria</option>
					<option value="az">Azurith</option>
					<option value="dr">Dryadalis</option>
					<option value="gi">Gigantoria</option>
					<option value="od">Odrheim</option>
					<option value="pr">Primoria</option>
					<option value="rh">Rheinland</option>
					<option value="tc">Trade Company</option>
					<option value="th">Tunglheimr</option>
					<option value="ts">Tsuki</option>
					<option disabled>─────────────────────────</option>
					<option value="ad">Ardeat</option>
					<option value="ge">Gelida</option>
					<option value="sc">Scientia</option>
				</select>
				<input class="custom-input" type="text" id="Title" placeholder="Title"></input>
				<span class="custom-subtitle"><font size="-1">Category</font></span>
				<select class="custom-select" name="Category" id="Category">
					<option value="capital" id="Town hall">Town hall</option>
					<option value="capital" id="Courthouse">Courthouse</option>
					<option value="capital" id="Religious institutions">Religious institutions</option>
					<option value="capital" id="Public squares">Public squares</option>
					<option disabled>─────────────────────────</option>
					<option value="cityBig" id="Merchant stall">Merchant stall</option>
					<option value="cityBig" id="Trading post">Trading post</option>
					<option value="cityBig" id="Food vendor">Food vendor</option>
					<option value="cityBig" id="Workshop">Workshop</option>
					<option disabled>─────────────────────────</option>
					<option value="citySmall" id="House">House</option>
					<option value="citySmall" id="Inn">Inn</option>
					<option disabled>─────────────────────────</option>
					<option value="town"id="Gate">Gate</option>
					<option value="town"id="Barracks">Barracks</option>
					<option value="town"id="Tower">Tower</option>
					<option disabled>─────────────────────────</option>
					<option value="nature" id="Forest">Forest</option>
					<option value="nature" id="Mountain">Mountain</option>
					<option value="nature" id="Cave">Cave</option>
					<option disabled>─────────────────────────</option>
					<option value="important" id="Important Location">Important Location</option>
					<option value="important" id="Historical Location">Historical Location</option>
					<option disabled>─────────────────────────</option>
					<option value="characters" id="Character">Character</option>
					</select>
				<input class="custom-input" type="text" id="Description" placeholder="Description"></input>
				<div class="custom-checkbox-container">
					<input class="custom-checkbox" type="checkbox" id="Link">
					<label for="Link">Link?</label>
				</div>
				<input class="custom-input" type="text" id="LinkText" placeholder="Custom link text (optional)"></input>
				<input class="custom-input" type="text" id="CustomId" placeholder="Custom id name (optional)"></input>
				<button class="custom-button" id="DevButton">Generate</button>
				<input class="custom-input" type="text" id="Output" placeholder="Output"></input>
			</div>
			`;

		//Marker Maker
		var marker = L.marker([0, 0], {
			draggable: true,
			id: "markerMaker"
		}).on('dragend', function() {
			marker.openPopup();
			markerMaker();
		});

		marker.bindPopup(formHTML).openPopup();
		marker.on('click', function(e) {
			markerMaker();
		});

		var regionLayerGroups = {
			'an': {
				'capital': L.layerGroup().addTo(map),
				'cityBig': L.layerGroup().addTo(map),
				'citySmall': L.layerGroup().addTo(map),
				'town': L.layerGroup().addTo(map),
				'nature': L.layerGroup().addTo(map),
				'important': L.layerGroup().addTo(map),
				'character': L.layerGroup().addTo(map)
			},
			'ts': {
				'capital': L.layerGroup(),
				'cityBig': L.layerGroup(),
				'citySmall': L.layerGroup(),
				'town': L.layerGroup(),
				'nature': L.layerGroup(),
				'important': L.layerGroup(),
				'character': L.layerGroup()
			},
		};

		//Marker Groups
		var an_all_layers = L.layerGroup([regionLayerGroups['an']['capital'], regionLayerGroups['an']['cityBig'], regionLayerGroups['an']['citySmall'], regionLayerGroups['an']['town'], regionLayerGroups['an']['nature'], regionLayerGroups['an']['important'], regionLayerGroups['an']['character']]);

		var ts_all_layers = L.layerGroup([regionLayerGroups['ts']['capital'], regionLayerGroups['ts']['cityBig'], regionLayerGroups['ts']['citySmall'], regionLayerGroups['ts']['town'], regionLayerGroups['ts']['nature'], regionLayerGroups['ts']['important'], regionLayerGroups['ts']['character']]);
		
		var dv_coord = L.layerGroup([marker]);

		var groups = [an_all_layers, ts_all_layers, dv_coord];
		const regionCodes = ['an', 'ts'];
		const layerTypes = ['capital', 'cityBig', 'citySmall', 'town', 'nature', 'important', 'character'];

		const layerGroups = [];

		regionCodes.forEach(regionCode => {
			layerTypes.forEach(layerType => {
				const layerGroup = regionLayerGroups[regionCode][layerType];
				if (layerGroup) { // Check if the layerGroup exists before adding
					layerGroups.push(layerGroup);
				}
			});
		});
		
		//Marker Overlay
		var overlays = {
			"Antaria": {
				"Civic Centers": regionLayerGroups['an']['capital'],
				"Market": regionLayerGroups['an']['cityBig'],
				"Residential": regionLayerGroups['an']['citySmall'],
				"Fortification": regionLayerGroups['an']['town'],
				"Nature": regionLayerGroups['an']['nature'],
				"Locations": regionLayerGroups['an']['important'],
				"Characters": regionLayerGroups['an']['character'],
			},
			"Tsuki": {
				"Civic Centers": regionLayerGroups['ts']['capital'],
				"Market": regionLayerGroups['ts']['cityBig'],
				"Residential": regionLayerGroups['ts']['citySmall'],
				"Fortification": regionLayerGroups['ts']['town'],
				"Nature": regionLayerGroups['ts']['nature'],
				"Locations": regionLayerGroups['ts']['important'],
				"Characters": regionLayerGroups['ts']['character'],
			},
			"Developer": {
				"Marker Maker": dv_coord,
			}
		};
		var options = {
			groupCheckboxes: true
		};
		var mapLayers = {
			"Antaria": antaria,
			"Tsuki": tsuki,
		}

		//GROUP CONTROLS
		L.control.groupedLayers(mapLayers, overlays, options).addTo(map);

		var controlSearchAn = new L.Control.Search({
			position:'topleft',		
			layer: an_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});
		var controlSearchTs = new L.Control.Search({
			position:'topleft',		
			layer: ts_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});

		var allSearch = [
			controlSearchAn,
			controlSearchTs, 
		];

		map.addControl( controlSearchAn );

		// Background color and Search to use for map
		var mapConfigurations = {
			'Antaria': {
				color: '#27180d',
				options: {
					'anOption1': {
						search: { controlSearch1: controlSearchAn },
						mapLayer: antaria,
						show: [an_all_layers],
						hide: [ts_all_layers],
						checkboxIndex: 0,
						checkboxState: true,
						hideCheckboxCount: 2,
					},
					'anOption2': {
						search: { controlSearch1: controlSearchAn },
						mapLayer: antaria,
						show: [an_all_layers],
						hide: [ts_all_layers],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
				},
				show: [an_all_layers],
				hide: [ts_all_layers],
				current: antaria,
				checkboxIndex: 0, 
				checkboxState: true,
				hideCheckBox: 2,
				defaultOptionId: 'anOption1',
			},
			'Tsuki': {
				color: '#FFFFFF',
				options: {
					'tsOption1': {
						search: { controlSearch1: controlSearchTs },
						mapLayer: tsuki,
						show: [ts_all_layers],
						hide: [an_all_layers],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
					'tsOption2': {
						search: { controlSearch1: controlSearchTs },
						mapLayer: tsuki,
						show: [ts_all_layers],
						hide: [an_all_layers],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
				},
				show: [ts_all_layers],
				hide: [an_all_layers],
				current: tsuki,
				checkboxIndex: 1, 
				checkboxState: true,
				hideCheckBox: 1,
				defaultOptionId: 'tsOption1',
			},
		};

		function addYearSelect() {
			var existingDropdown = document.getElementById('YearSelector');
			if (existingDropdown) {
				// If it exists, remove it before creating a new one
				existingDropdown.remove();
			}

			// Find the checked radio button
			var checkedRadioButton = document.querySelector('.leaflet-control-layers-base input[type="radio"]:checked');
			if (checkedRadioButton) {
				var label = checkedRadioButton.nextElementSibling;
			} else {
				console.error("No radiobutton found.");
			}

			// Create the dropdown box
			var dropdown = document.createElement('select');
			dropdown.name = 'options';
			dropdown.id = "YearSelector";
			dropdown.className = 'custom-select';

			// Add options to the dropdown
			switch (label && label.textContent.trim()) {
				case "Antaria": {
					createSelect("Antaria", "anOption1", dropdown);
					createSelect("Other City", "anOption2", dropdown);
					break;
				}
				case "Tsuki": {
					createSelect("Getsuyōsei", "tsOption1", dropdown);
					createSelect("Other City", "tsOption2", dropdown);
					break;
				}
			}

			// Insert the dropdown after the parent label of the checked radio button
			if (checkedRadioButton) {
				checkedRadioButton.closest('label').after(dropdown);
			} else if (lastCheckedRadioButtonLabel) {
				// Find the label with the text in lastCheckedRadioButtonLabel
				var labels = document.getElementsByTagName('label');
				for (var i = 0; i < labels.length; i++) {
					var label = labels[i];
					var span = label.querySelector('span');
					if (span && span.textContent.trim() === lastCheckedRadioButtonLabel) {
						console.log("Found Label")
						label.after(dropdown);
						break;
					}
				}
			} else {
				console.log("No radiobutton found");
			}
		}

		// Wait for the DOM to be ready
		function addRadioButtons(checked) {
			// Simplified createRadioButton function
			function createRadioButton(label, value, isChecked) {
				var radio = document.createElement("input");
				radio.type = "radio";
				radio.name = "layerSelector";
				radio.value = value;
				radio.checked = isChecked; // Direct assignment
				radio.classList.add("custom-radio-class");

				var labelElement = document.createElement("label");
				labelElement.appendChild(radio);
				labelElement.appendChild(document.createTextNode(label));
				return labelElement;
			}

			// Get the overlay control container
			var overlayContainer = document.querySelector('.leaflet-control-layers-overlays');

			// Check and remove existing radio buttons and separators
			var existingRadios = overlayContainer.querySelectorAll('.custom-radio-class');
			var existingSeparators = overlayContainer.querySelectorAll('.leaflet-control-layers-separator');

			existingRadios.forEach(function(radio) {
				radio.parentNode.remove(); // This assumes the radio button is wrapped in a label
			});
			existingSeparators.forEach(function(separator) {
				separator.remove();
			});

			// Create and append the separator div
			var separatorDiv = document.createElement("div");
			separatorDiv.classList.add("leaflet-control-layers-separator");
			overlayContainer.appendChild(separatorDiv);

			// Loop to create and append radio buttons
			radioButtonsInfo.forEach(info => {
				var radioButton = createRadioButton(info.label, info.option, checked === info.checkedIndex);
				radioButton.classList.add("leaflet-control-layers-selector");
				overlayContainer.appendChild(radioButton);
			});
		};

		document.addEventListener('DOMContentLoaded', function () {
			// Check the main checkbox
			var checkbox = document.querySelector('.leaflet-control-layers-group-selector');
			checkbox.checked = true;
			addRadioButtons(1)
			hideCheckBoxes(2);
			addYearSelect();
			document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
			fetch('data/cityMarkers.json')
				.then(response => response.json())
				.then(data => {
					processImportedData(data);
				})
				.catch(error => console.error('Error loading markers.json:', error));
		});

		const zoomControl = document.querySelector('.leaflet-control-zoom.leaflet-bar.leaflet-control');

		if (zoomControl) {
			const wikiButton = createControlButton('wiki', 'Wiki', 'icons/web1.png', 'icons/web2.png', (e) => {
				e.preventDefault();
				window.open('wiki', '_blank');
			});

			const worldButton = createControlButton('world', 'Opens the world map', 'icons/world1.png', 'icons/world2.png', (e) => {
				e.preventDefault();
				window.open('');
			});

			const exportButton = createControlButton('#', 'Export JSON', 'icons/export1.png', 'icons/export2.png', (e) => {
				e.preventDefault();
				exportMarkersToJson();
			});

			const importButton = createControlButton('#', 'Import JSON', 'icons/import1.png', 'icons/import2.png', (e) => {
				e.preventDefault();
				fileInput.click();
			});

			zoomControl.insertAdjacentElement('beforeend', wikiButton);
			zoomControl.insertAdjacentElement('beforeend', worldButton);
			zoomControl.insertAdjacentElement('beforeend', exportButton);
			zoomControl.insertAdjacentElement('beforeend', importButton);
		} else {
			console.error('Zoom control element not found');
		}

		document.getElementsByClassName('leaflet-control-attribution')[0].style.display = 'none';

		function createFileInput() {
			var fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.json';
			fileInput.style.display = 'none';

			fileInput.addEventListener('change', function(event) {
				var file = event.target.files[0];
				if (file) {
					var reader = new FileReader();
					reader.onload = function(e) {
						var jsonData = JSON.parse(e.target.result);
						processImportedData(jsonData);
					};
					reader.readAsText(file);
				}
			});

			document.body.appendChild(fileInput);
			return fileInput;
		}
	</script>		
</body>

</html>