<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icons/arathia.png">
    <title>Character Catalog</title>
    <style>
        :root {
            --background: #100f0feb;
            --foreground: #9f957e;
            --highlight: #ffe7ab;
            --highlight2: #ddbc6a;
            --highlight-background: #ddbd6a50;
        }
        body {
            color: var(--foreground);
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .main-container {
            background-color: var(--background);
            border: 9px solid transparent;
            border-image-source: url(../icons/border.png);
            border-image-width: 20px 40px;
            border-image-repeat: round;
            border-image-slice: 30 50 fill;
            padding: 10px;
            border-radius: 6px;
            margin: auto;
            max-width: 800px;
        }
        details {
            background: var(--background);
            border-radius: 4px;
            padding: 10px;
            padding-left: 15px;
            margin-bottom: 0px;
        }
        details[open] {
            padding-bottom: 0;
        }
        summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--highlight);
            padding: 8px;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        ul {
            list-style: none;
            padding-left: 8px;
        }

        li {
            margin-bottom: 8px;
        }

        h1 {
            margin-bottom: 5px;
        }

        .header-container {
            text-align: center;
            margin-bottom: 16px;
        }
        .character-name {
            display: inline-block;
            padding-left: 15px;
        }
        .search-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        .search-box {
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid var(--foreground);
            background-color: var(--background);
            color: var(--highlight);
        }
        .search-results {
            position: absolute;
            background-color: var(--background);
            color: var(--foreground);
            border: 1px solid var(--highlight);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
            display: none; /* Initially hidden */
        }
        .search-result-item {
            padding: 5px;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: var(--highlight-background);
        }
        .maincategory {
            margin-bottom: 5px;
        }
        .character-entry {
            border: 1px solid var(--highlight);
            border-radius: 4px;
            background: var(--background);
            color: var(--foreground);
            border-radius: 4px;
            margin: 8px 0; /* Adjusted for even spacing */
            padding: 8px;
            list-style-type: none; /* Removes bullet points */
        }

        .character-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Space between the header and the summary */
        }

        .character-name {
            font-weight: bold;
            color: var(--highlight);
        }

        .copy-btn {
            background-color: var(--highlight);
            color: var(--background);
            border: none;
            border-radius: 4px;
            padding: 5px 8px; /* Adjusted padding for better visual */
            cursor: pointer;
            font-size: 12px;
        }

        .character-summary {
            display: block; /* Ensures the summary is block-level for proper spacing */
            margin-top: 8px; /* Space after the divider */
            color: var(--foreground); /* Ensures readability */
            text-align: justify; /* Justifies the summary text for cleaner appearance */
        }

        .character-entry img {
            height: 12.5px;
            width: 100%;
            min-width: 175px;
            display: block;
            margin: 8px auto; /* Ensures the divider is centered with proper spacing */
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="search-container">
        <input type="text" class="search-box" id="search-box" placeholder="Search characters or categories..." oninput="filterCharacters(this.value)">
        <div id="search-results" class="search-results"></div>
    </div>
    <div class="header-container">
        <h1>Arathia Character Catalog</h1>
        <div>Total Characters: <span id="total-characters">0</span></div> 
    </div>
    <template id="character-template">
        <li class="character-entry">
          <div>
            <div class="character-header">
                <span class="character-name"></span>
                <button class="copy-btn">Copy Name</button>
            </div>
            <img src="icons/divider.png" alt="map popup divider">
            <span class="character-summary"></span>
          </div>
        </li>
      </template>      
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/data/characters.json')
            .then(response => response.json())
            .then(data => {
                const container = document.querySelector('.main-container');
                const template = document.getElementById('character-template').content;

                Object.entries(data).forEach(([mainCategory, characters]) => {
                    const mainDetailsElement = document.createElement('details');
                    const mainSummaryElement = document.createElement('summary');
                    mainSummaryElement.textContent = mainCategory;
                    mainDetailsElement.appendChild(mainSummaryElement);

                    const mainCategoryCharacters = document.createElement('ul');

                    characters.forEach(character => {
                        const clone = document.importNode(template, true);
                        clone.querySelector('.character-name').textContent = character.name;
                        clone.querySelector('.character-summary').textContent = character.summary;
                        clone.querySelector('.copy-btn').onclick = () => copyToClipboard(character.name);
                        if (character.category) {
                            let subcategoryList = mainDetailsElement.querySelector(`[data-category="${character.category}"]`);
                            if (!subcategoryList) {
                                const subDetailsElement = document.createElement('details');
                                const subSummaryElement = document.createElement('summary');
                                subSummaryElement.textContent = character.category;
                                subDetailsElement.appendChild(subSummaryElement);

                                subcategoryList = document.createElement('ul');
                                subcategoryList.setAttribute('data-category', character.category);
                                subDetailsElement.appendChild(subcategoryList);
                                mainDetailsElement.appendChild(subDetailsElement);
                            }
                            subcategoryList.appendChild(clone);
                        } else {
                            mainCategoryCharacters.appendChild(clone);
                        }
                    });

                    if (mainCategoryCharacters.childElementCount > 0) {
                        mainDetailsElement.appendChild(mainCategoryCharacters);
                    }

                    container.appendChild(mainDetailsElement);
                });
            })
            .catch(error => console.error('Error loading character data:', error));
        });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
        }).catch(err => {
            console.error('Failed to copy text to clipboard', err);
        });
    }


    function filterCharacters(query) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = ''; // Clear previous results
        let foundCharacters = new Map();
        let foundCategories = new Map();

        if(query.trim() === '') {
            resultsContainer.style.display = 'none';
            return;
        }

        // Lowercase query for case-insensitive comparison
        const lowerQuery = query.toLowerCase();

        // Collect characters and categories
        document.querySelectorAll('details').forEach((detail) => {
            const summary = detail.querySelector('summary');
            if (summary && summary.textContent.toLowerCase().includes(lowerQuery)) {
                // Use original text case for display
                foundCategories.set(summary.textContent, detail);
            }

            detail.querySelectorAll('.character-name').forEach((character) => {
                if (character.textContent.toLowerCase().includes(lowerQuery)) {
                    // Use original text case for display
                    foundCharacters.set(character.textContent, character.parentElement);
                }
            });
        });

        // Display characters first
        foundCharacters.forEach((element, name) => {
            addResultItem(name, element, resultsContainer);
        });

        // Add a divider if both characters and categories are found
        if (foundCharacters.size > 0 && foundCategories.size > 0) {
            addDivider(resultsContainer);
        }

        // Display categories next
        foundCategories.forEach((element, name) => {
            addResultItem(name, element, resultsContainer);
        });

        resultsContainer.style.display = (foundCharacters.size > 0 || foundCategories.size > 0) ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchBox = document.getElementById('search-box');
        const resultsContainer = document.getElementById('search-results');
        let hideResultsTimeout;

        searchBox.addEventListener('blur', function() {
            // Set a timeout to hide the results, allowing time for a click to register
            hideResultsTimeout = setTimeout(() => {
            resultsContainer.style.display = 'none';
            }, 200); // Adjust delay as needed
        });

        // Prevent hiding if the search results are being interacted with
        resultsContainer.addEventListener('mousedown', function(e) {
            clearTimeout(hideResultsTimeout);
        });

        // Additional code for filterCharacters and other functionalities
    });

    function addResultItem(text, targetElement, container) {
        const item = document.createElement('div');
        item.textContent = text;
        item.classList.add('search-result-item');
        item.onclick = () => {
            // Open all parent <details> for the target element
            let parent = targetElement.parentElement;
            while (parent) {
                if (parent.tagName.toLowerCase() === 'details') {
                    parent.open = true;
                }
                parent = parent.parentElement;
            }
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            container.style.display = 'none'; // Hide results
        };
        container.appendChild(item);
    }

    function addDivider(container) {
        const divider = document.createElement('div');
        divider.innerHTML = '───────────────────────────────────────────────────'; // Visual divider
        divider.classList.add('search-result-divider');
        container.appendChild(divider);
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/data/characters.json')
            .then(response => response.json())
            .then(data => {
            const container = document.querySelector('.main-container');
            let characterCount = 0; // Initialize character count

            Object.entries(data).forEach(([mainCategory, characters]) => {
                // Existing logic to create and append mainCategory and characters
                // For each character processed, increment characterCount
                characterCount += characters.length;

                // Existing logic to append details and characters to the container
            });

            // After all characters have been processed, update the character count display
            document.getElementById('total-characters').textContent = characterCount;
            })
            .catch(error => console.error('Error loading character data:', error));
        });
</script>

</body>
</html>
