<!DOCTYPE html>
<html = style="height: 100%;">

<head>
	<title>Arathia World Map</title>
	<meta charset="UTF-8">
	<link rel="icon" href="icons/arathia.png">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="scripts/leaflet.css">
	<link rel="stylesheet" href="scripts/src/leaflet.groupedlayercontrol.css" />
	<link rel="stylesheet" href="scripts/leaflet-search/src/leaflet-search.css" />
	<link rel="stylesheet" href="style/style.css">
	<script src="scripts/leaflet.js"></script>
	<script src="scripts/src/leaflet.groupedlayercontrol.js"></script>
	<script src="scripts/leaflet-search/src/leaflet-search.js"></script>
</head>

<body style="height: 100%;margin: 0;overflow-y: hidden;overflow-x: hidden;">
	<div id="map" style="width: 100%; height: 100%; background: #31565a;"></div>
	<a class="leaflet-control-zoom-out" href="index" title="Zoom out" role="button"
        aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">−</span></a>
	<script src="scripts/custom-scripts.js"></script>
	<script type="text/javascript">
		// MAPS
		var radioButtonsInfo = [
			{ label: "Default Icons", option: "option1", checkedIndex: 1, suffix: '' },
			{ label: "Old Icons", option: "option2", checkedIndex: 2, suffix: 'Old' },
			{ label: "Simple Icons", option: "option3", checkedIndex: 3, suffix: 'Simple' }
		];

		var neededMaps = [
			arathia,
			arathiaClean,
			morturia
		];

		var oldSuffix = "";
		var currentSelectedMap = arathia;
		var selectedOptionId = 'arOption1';
		var iconChecked = 1;
		var currentMap = 'Arathia';

		// Define a map to convert between optionIds when switching map types
		var optionIdConversions = {
			'arOption2': 'arCleanOption2',
			'moOption2': 'moCleanOption2'
		};

		const regionMap = {
			"an": "ar",
			"od": "ar",
			"th": "ar",
			"rh": "ar",
			"az": "ar",
			"ts": "ar",
			"pr": "ar",
			"dr": "ar",
			"tc": "ar",
			"gi": "ar",
			"ac": "ar",
		};

		var southWest = L.latLng(-70, -170),
			northEast = L.latLng(70, 170),
			bounds = L.latLngBounds(southWest, northEast);

		//Creating the Map
		var map = L.map('map', {
			maxBounds: bounds,
			zoomSnap: 0.1,
			zoomDelta: 0.5,
			wheelPxPerZoomLevel: 120,
		}).setView([0, 0], 0);

		map.createPane('addPane');
		map.createPane('basePane');
		map.createPane('backgroundPane');

		map.getPane('addPane').style.zIndex = 250;
		map.getPane('basePane').style.zIndex = 220;
		map.getPane('backgroundPane').style.zIndex = 150;

		// Maps createMap(title, noWrap, minZoom, maxZoom, pane, add)
		var arathia = createMap('Main', 'arathia', true, 2.75, 5.4, 'basePane', true);
		var arathiaClean = createMap('Main', 'arathiaClean', true, 2.75, 5.4, 'basePane', false);
		var Test = createMap('Main', 'morturia', true, 2.75, 5.4, 'addPane', false);
		var Test2 = createMap('Main', 'morturia', true, 2.75, 5.4, 'addPane', false);
		var Test3 = createMap('Main', 'morturia', true, 2.75, 5.4, 'addPane', false);
		var Test4 = createMap('Main', 'morturia', true, 2.75, 5.4, 'addPane', false);
		var morturia = createMap('Main', 'morturia', true, 2.75, 5.4, 'basePane', false);
		var arathiaBackground = createMap('Main', 'arathiaBackground', false, 2.75, 5.4, 'backgroundPane', true);
		var morturiaBackground = createMap('Main', 'morturiaBackground', false, 2.75, 5.4, 'backgroundPane', false);

		// Icons Settings: { size = image size, anchor = where on the image is on the coordinate, popupAnchor = where the popup will be anchored to the marker }
		var defaultIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var oldIconSettings = { size: [31, 41], anchor: [15, 41], popupAnchor: [1, -44] };
		var simpleIconSettings = { size: [31, 41], anchor: [15, 25], popupAnchor: [1, -22] };

		// Icons
		var icons = {
			capital: createIcon('capital', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			cityBig: createIcon('cityBig', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			citySmall: createIcon('citySmall', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			town: createIcon('town', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			nature: createIcon('nature', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			important: createIcon('important', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
			character: createIcon('character', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor),
	
			capitalOld: createIcon('capitalOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			cityBigOld: createIcon('cityBigOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			citySmallOld: createIcon('citySmallOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			townOld: createIcon('townOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			natureOld: createIcon('natureOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			importantOld: createIcon('importantOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),
			characterOld: createIcon('characterOld', 'defaultShadow', oldIconSettings.size, oldIconSettings.anchor, oldIconSettings.popupAnchor),

			capitalSimple: createIcon('capitalSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			cityBigSimple: createIcon('cityBigSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor),
			citySmallSimple: createIcon('citySmallSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 4] }).popupAnchor),
			townSimple: createIcon('townSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 6] }).popupAnchor),
			natureSimple: createIcon('natureSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0, 8] }).popupAnchor),
			importantSimple: createIcon('importantSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, adjustSettings(simpleIconSettings, { popupAnchor: [0.5, 0] }).popupAnchor),
			characterSimple: createIcon('characterSimple', 'transparent', simpleIconSettings.size, simpleIconSettings.anchor, simpleIconSettings.popupAnchor),

			defaultIcon: createIcon('marker-icon', 'defaultShadow', defaultIconSettings.size, defaultIconSettings.anchor, defaultIconSettings.popupAnchor)
		}

		var fileInput = createFileInput();

		var formHTML = `
			<div class="custom-container">
				<span class="custom-title"><font size="+0.5">Marker Maker</font></span>
				<span class="custom-subtitle"><font size="-1">Coords</font></span>
				<input class="custom-input" type="text" id="Coords" placeholder="Coords"></input>
				<img style="height:3px;width: 100%; display: block; margin-left: auto; margin-right: auto; margin-bottom: 0px; margin-top: 0px;" src="icons/divider_small.png" alt="map popup divider">
				<span class="custom-subtitle"><font size="-1">Country</font></span>
				<select class="custom-select" name="Id" id="Id">
					<option value="ac">Arcarum</option>
					<option value="an">Antaria</option>
					<option value="az">Azurith</option>
					<option value="dr">Dryadalis</option>
					<option value="gi">Gigantoria</option>
					<option value="od">Odrheim</option>
					<option value="pr">Primoria</option>
					<option value="rh">Rheinland</option>
					<option value="tc">Trade Company</option>
					<option value="th">Tunglheimr</option>
					<option value="ts">Tsuki</option>
					<option disabled>─────────────────────────</option>
					<option value="ad">Ardeat</option>
					<option value="ge">Gelida</option>
					<option value="sc">Scientia</option>
				</select>
				<input class="custom-input" type="text" id="Title" placeholder="Title"></input>
				<span class="custom-subtitle"><font size="-1">Category</font></span>
				<select class="custom-select" name="Category" id="Category">
					<option value="capital" id="Capital">Capital</option>
					<option value="cityBig" id="Big City">Big City</option>
					<option value="citySmall" id="Small City">Small City</option>
					<option value="town"id="Town">Town</option>
					<option disabled>─────────────────────────</option>
					<option value="nature" id="Forest">Forest</option>
					<option value="nature" id="Mountain">Mountain</option>
					<option value="nature" id="Cave">Cave</option>
					<option disabled>─────────────────────────</option>
					<option value="important" id="Important Location">Important Location</option>
					<option value="important" id="Historical Location">Historical Location</option>
					<option disabled>─────────────────────────</option>
					<option value="character" id="Character">Character</option>
					</select>
				<input class="custom-input" type="text" id="Description" placeholder="Description"></input>
				<div class="custom-checkbox-container">
					<input class="custom-checkbox" type="checkbox" id="Link">
					<label for="Link">Link?</label>
				</div>
				<input class="custom-input" type="text" id="LinkText" placeholder="Custom link text (optional)"></input>
				<input class="custom-input" type="text" id="CustomId" placeholder="Custom id name (optional)"></input>
				<button class="custom-button" id="DevButton">Generate</button>
				<input class="custom-input" type="text" id="Output" placeholder="Output"></input>
			</div>
			`;

		//Marker Maker
		var marker = L.marker([0, 0], {
			draggable: true,
			id: "markerMaker"
		}).on('dragend', function() {
			marker.openPopup();
			markerMaker();
		});

		marker.bindPopup(formHTML).openPopup();
		marker.on('click', function(e) {
			markerMaker();
		});

		var regionLayerGroups = {
			'ar': {
				'capital': L.layerGroup().addTo(map),
				'cityBig': L.layerGroup().addTo(map),
				'citySmall': L.layerGroup().addTo(map),
				'town': L.layerGroup().addTo(map),
				'nature': L.layerGroup().addTo(map),
				'important': L.layerGroup().addTo(map),
				'character': L.layerGroup().addTo(map)
			},
			'mo': {
				'capital': L.layerGroup(),
				'cityBig': L.layerGroup(),
				'citySmall': L.layerGroup(),
				'town': L.layerGroup(),
				'nature': L.layerGroup(),
				'important': L.layerGroup(),
				'character': L.layerGroup()
			},
		};

		//Marker Groups
		var ar_all_layers = L.layerGroup([regionLayerGroups['ar']['capital'], regionLayerGroups['ar']['cityBig'], regionLayerGroups['ar']['citySmall'], regionLayerGroups['ar']['town'], regionLayerGroups['ar']['nature'], regionLayerGroups['ar']['important'], regionLayerGroups['ar']['character']]);

		var mo_all_layers = L.layerGroup([regionLayerGroups['mo']['capital'], regionLayerGroups['mo']['cityBig'], regionLayerGroups['mo']['citySmall'], regionLayerGroups['mo']['town'], regionLayerGroups['mo']['nature'], regionLayerGroups['mo']['important'], regionLayerGroups['mo']['character']]);
		
		var dv_coord = L.layerGroup([marker]);

		var groups = [ar_all_layers, mo_all_layers, dv_coord];
		const regionCodes = ['ar', 'mo'];
		const layerTypes = ['capital', 'cityBig', 'citySmall', 'town', 'nature', 'important', 'character'];

		const layerGroups = [];

		regionCodes.forEach(regionCode => {
			layerTypes.forEach(layerType => {
				const layerGroup = regionLayerGroups[regionCode][layerType];
				if (layerGroup) { // Check if the layerGroup exists before adding
					layerGroups.push(layerGroup);
				}
			});
		});
		
		//Marker Overlay
		var overlays = {
			"Arathia": {
				"Capitals": regionLayerGroups['ar']['capital'],
				"Large Cities": regionLayerGroups['ar']['cityBig'],
				"Small Cities": regionLayerGroups['ar']['citySmall'],
				"Towns": regionLayerGroups['ar']['town'],
				"Nature": regionLayerGroups['ar']['nature'],
				"Locations": regionLayerGroups['ar']['important'],
				"Characters": regionLayerGroups['ar']['character'],
			},
			"Morturia": {
				"Capitals": regionLayerGroups['mo']['capital'],
				"Large Cities": regionLayerGroups['mo']['cityBig'],
				"Small Cities": regionLayerGroups['mo']['citySmall'],
				"Towns": regionLayerGroups['mo']['town'],
				"Nature": regionLayerGroups['mo']['nature'],
				"Locations": regionLayerGroups['mo']['important'],
				"Characters": regionLayerGroups['mo']['character'],
			},
			"Developer": {
				"Marker Maker": dv_coord,
			}
		};
		var options = {
			groupCheckboxes: true
		};
		var mapLayers = {
			"Arathia": arathia,
			"Arathia Clean": arathiaClean,
			"Morturia": morturia,
		}

		//GROUP CONTROLS
		L.control.groupedLayers(mapLayers, overlays, options).addTo(map);

		var controlSearchAr = new L.Control.Search({
			position:'topleft',		
			layer: ar_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});
		var controlSearchMo = new L.Control.Search({
			position:'topleft',		
			layer: mo_all_layers, 
			zoom: 5,
			initial: false,
			marker: false
		}).on("search:locationfound", function (e) {
			if (e.layer._popup) e.layer.openPopup();
		});

		var allSearch = [
			controlSearchAr, 
			controlSearchMo
		];

		map.addControl( controlSearchAr );

		// Background color and Search to use for map
		var mapConfigurations = {
			'Arathia': {
				color: '#31565a',
				options: {
					'arOption1': {
						search: { controlSearch1: controlSearchAr },
						mapLayer: arathia,
						show: [ar_all_layers, arathiaBackground],
						hide: [mo_all_layers, morturiaBackground],
						checkboxIndex: 0,
						checkboxState: true,
						hideCheckboxCount: 2,
					},
					'arOption2': {
						search: { controlSearch1: controlSearchMo },
						mapLayer: Test,
						show: [mo_all_layers, arathiaBackground],
						hide: [ar_all_layers, morturiaBackground],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
				},
				show: [ar_all_layers, arathiaBackground],
				hide: [mo_all_layers, morturiaBackground],
				current: arathia,
				checkboxIndex: 0, 
				checkboxState: true,
				hideCheckBox: 2,
				defaultOptionId: 'arOption1',
			},
			'Arathia Clean': {
				color: '#31565a',
				options: {
					'arCleanOption1': {
						search: { controlSearch1: controlSearchAr },
						mapLayer: arathiaClean,
						show: [arathiaBackground],
						hide: [mo_all_layers, ar_all_layers, morturiaBackground],
						checkboxIndex: 0,
						checkboxState: false,
						hideCheckboxCount: 2,
					},
					'arCleanOption2': {
						search: { controlSearch1: controlSearchMo },
						mapLayer: Test3,
						show: [arathiaBackground],
						hide: [mo_all_layers, ar_all_layers, morturiaBackground],
						checkboxIndex: 1,
						checkboxState: false,
						hideCheckboxCount: 1,
					},
				},
				show: [arathiaBackground],
				hide: [mo_all_layers, ar_all_layers, morturiaBackground],
				current: arathiaClean,
				checkboxIndex: 0, 
				checkboxState: false,
				hideCheckBox: 2,
				defaultOptionId: 'arCleanOption1',
			},
			'Morturia': {
				color: '#374539',
				options: {
					'moOption1': {
						search: { controlSearch1: controlSearchMo },
						mapLayer: morturia,
						show: [mo_all_layers, morturiaBackground],
						hide: [ar_all_layers, arathiaBackground],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
					'moOption2': {
						search: { controlSearch1: controlSearchAr },
						mapLayer: morturia,
						show: [mo_all_layers, morturiaBackground],
						hide: [ar_all_layers, arathiaBackground],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
				},
				show: [mo_all_layers, morturiaBackground],
				hide: [ar_all_layers, arathiaBackground],
				current: morturia,
				checkboxIndex: 1, 
				checkboxState: true,
				hideCheckBox: 1,
				defaultOptionId: 'moOption1',
			},
			'Morturia Clean': {
				color: '#374539',
				options: {
					'moCleanOption1': {
						search: { controlSearch1: controlSearchMo },
						mapLayer: morturia,
						show: [mo_all_layers, morturiaBackground],
						hide: [ar_all_layers, arathiaBackground],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
					'moCleanOption2': {
						search: { controlSearch1: controlSearchAr },
						mapLayer: morturia,
						show: [morturiaBackground],
						hide: [mo_all_layers, ar_all_layers, arathiaBackground],
						checkboxIndex: 1,
						checkboxState: true,
						hideCheckboxCount: 1,
					},
				},
				show: [morturiaBackground],
				hide: [mo_all_layers, ar_all_layers, arathiaBackground],
				current: morturia,
				checkboxIndex: 1, 
				checkboxState: false,
				hideCheckBox: 1,
				defaultOptionId: 'moCleanOption1',
			},
		};

		function addYearSelect() {
			var existingDropdown = document.getElementById('YearSelector');
			if (existingDropdown) {
				// If it exists, remove it before creating a new one
				existingDropdown.remove();
			}

			// Find the checked radio button
			var checkedRadioButton = document.querySelector('.leaflet-control-layers-base input[type="radio"]:checked');
			if (checkedRadioButton) {
				var label = checkedRadioButton.nextElementSibling;
			} else {
				console.error("No radiobutton found.");
			}

			// Create the dropdown box
			var dropdown = document.createElement('select');
			dropdown.name = 'options';
			dropdown.id = "YearSelector";
			dropdown.className = 'custom-select';

			// Add options to the dropdown
			switch (label && label.textContent.trim()) {
				case "Arathia": {
					createSelect("1257 A.A", "arOption1", dropdown);
					createSelect("67 B.A", "arOption2", dropdown);
					break;
				}
				case "Arathia Clean": {
					createSelect("1257 A.A", "arCleanOption1", dropdown);
					createSelect("67 B.A", "arCleanOption2", dropdown); 
					break;
				}
				case "Morturia": {
					createSelect("1257 A.A", "moOption1", dropdown);
					createSelect("???", "moOption2", dropdown); 
					break;
				}
			}

			// Insert the dropdown after the parent label of the checked radio button
			if (checkedRadioButton) {
				checkedRadioButton.closest('label').after(dropdown);
			} else if (lastCheckedRadioButtonLabel) {
				// Find the label with the text in lastCheckedRadioButtonLabel
				var labels = document.getElementsByTagName('label');
				for (var i = 0; i < labels.length; i++) {
					var label = labels[i];
					var span = label.querySelector('span');
					if (span && span.textContent.trim() === lastCheckedRadioButtonLabel) {
						console.log("Found Label")
						label.after(dropdown);
						break;
					}
				}
			} else {
				console.log("No radiobutton found");
			}
		}

		// Wait for the DOM to be ready
		function addRadioButtons(checked) {
			// Simplified createRadioButton function
			function createRadioButton(label, value, isChecked) {
				var radio = document.createElement("input");
				radio.type = "radio";
				radio.name = "layerSelector";
				radio.value = value;
				radio.checked = isChecked; // Direct assignment
				radio.classList.add("custom-radio-class");

				var labelElement = document.createElement("label");
				labelElement.appendChild(radio);
				labelElement.appendChild(document.createTextNode(label));
				return labelElement;
			}

			// Get the overlay control container
			var overlayContainer = document.querySelector('.leaflet-control-layers-overlays');

			// Check and remove existing radio buttons and separators
			var existingRadios = overlayContainer.querySelectorAll('.custom-radio-class');
			var existingSeparators = overlayContainer.querySelectorAll('.leaflet-control-layers-separator');

			existingRadios.forEach(function(radio) {
				radio.parentNode.remove(); // This assumes the radio button is wrapped in a label
			});
			existingSeparators.forEach(function(separator) {
				separator.remove();
			});

			// Create and append the separator div
			var separatorDiv = document.createElement("div");
			separatorDiv.classList.add("leaflet-control-layers-separator");
			overlayContainer.appendChild(separatorDiv);

			// Loop to create and append radio buttons
			radioButtonsInfo.forEach(info => {
				var radioButton = createRadioButton(info.label, info.option, checked === info.checkedIndex);
				radioButton.classList.add("leaflet-control-layers-selector");
				overlayContainer.appendChild(radioButton);
			});
		};

		document.addEventListener('DOMContentLoaded', function () {
			// Check the main checkbox
			var checkbox = document.querySelector('.leaflet-control-layers-group-selector');
			checkbox.checked = true;
			addRadioButtons(1)
			hideCheckBoxes(2);
			addYearSelect();
			document.getElementById('YearSelector').addEventListener('change', updateSelectedOptionId);
			fetch('data/markers.json')
				.then(response => response.json())
				.then(data => {
					processImportedData(data);
				})
				.catch(error => console.error('Error loading markers.json:', error));
		});

		const zoomControl = document.querySelector('.leaflet-control-zoom.leaflet-bar.leaflet-control');

		if (zoomControl) {
			const wikiButton = createControlButton('wiki', 'Wiki', 'icons/web1.png', 'icons/web2.png', (e) => {
				e.preventDefault();
				window.open('wiki', '_blank');
			});

			const exportButton = createControlButton('#', 'Export JSON', 'icons/export1.png', 'icons/export2.png', (e) => {
				e.preventDefault();
				exportMarkersToJson();
			});

			const importButton = createControlButton('#', 'Import JSON', 'icons/import1.png', 'icons/import2.png', (e) => {
				e.preventDefault();
				fileInput.click();
			});

			zoomControl.insertAdjacentElement('beforeend', wikiButton);
			zoomControl.insertAdjacentElement('beforeend', exportButton);
			zoomControl.insertAdjacentElement('beforeend', importButton);
		} else {
			console.error('Zoom control element not found');
		}

		document.getElementsByClassName('leaflet-control-attribution')[0].style.display = 'none';

		function createFileInput() {
			var fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.json';
			fileInput.style.display = 'none';

			fileInput.addEventListener('change', function(event) {
				var file = event.target.files[0];
				if (file) {
					var reader = new FileReader();
					reader.onload = function(e) {
						var jsonData = JSON.parse(e.target.result);
						processImportedData(jsonData);
					};
					reader.readAsText(file);
				}
			});

			document.body.appendChild(fileInput);
			return fileInput;
		}
	</script>		
</body>

</html>